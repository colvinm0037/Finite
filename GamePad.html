<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <script type="text/javascript" src="jquery-2.2.1.min.js"></script> 
    </head>
    
	<script>		
	var buttons = ["X", "Circle", "Square", "Triangle", "L1", "R1", "L2", "R2", "Share", "Options", "L3", "R3", "Up", "Down", "Left", "Right", "Home", "Touchpad"];
    var previouslyPressed = [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false];
	var currentlyPressed = [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false];
	var hasDS4 = false;
	var lastPress = "";
    var reportDS4;
	var buttonLog = "";

	// Note: DFA charts use simplified mapping. Controller has 18 buttons, but we only care about 8 directions and punch + kick
	var revisedMappings = ["Up", "Down", "Left", "Right", "Up-Right", "Down-Right", "Down-Left", "Up-Left", "Punch", "Kick"];
	
  	var mappings = [ [0, 1, 0, 0, 0, 0, 0, 0, 0, 0], // state 0
					 [0, 1, 0, 0, 0, 5, 2, 0, 0, 0], // state 1
					 [0, 1, 3, 0, 0, 0, 0, 0, 0, 0], // state 2
					 [0, 1, 0, 0, 0, 0, 0, 0, 0, 4], // state 3
					 [0, 1, 0, 0, 0, 0, 0, 0, 0, 0], // state 4
					 [0, 1, 0, 6, 0, 0, 0, 0, 0, 0], // state 5
					 [0, 1, 0, 0, 0, 0, 0, 0, 7, 0], // state 6
					 [0, 1, 0, 0, 0, 0, 0, 0, 0, 0], // state 7
					];
	
    var currentPosition = 0;
	var timeCounter = 0;
	
	function determinePosition(diagonals) {
	
		var button = 0;		
	
		if (diagonals === true) {
			button = diagonalMapping();
		}
		else {
			button = regularMapping();
		}
		
		if (button === -1) return;
		timeCounter = 0;
		buttonLog += revisedMappings[button] + " ";
		
		currentPosition = mappings[currentPosition][button];
		
		var move = "None";	

		// Check if a move has occurred
		if (currentPosition == 4) move = "HURRICANE KICK";
		if (currentPosition == 7) move = "HADOKEN";
		
		// Display the move 
		$("#move").html(move);
	}
	
	// Simplified Mappings only for diagonals
	function diagonalMapping() {
	
		var button = -1;

		if (currentlyPressed[12]) {
			button = 0;
		} else if (currentlyPressed[13]) {
			button = 1;
		} else if (currentlyPressed[14]) {
			button = 2;
		} else if (currentlyPressed[15]) {
			button = 3;
		} 

		return button;
	}

	// Simplified mappings for all actions we care about
	function regularMapping() {
		
		var button= -1;
		
		if (currentlyPressed[2] || currentlyPressed[3] || currentlyPressed[4] || currentlyPressed[5]) {
			button = 8;
		} else if (currentlyPressed[0] || currentlyPressed[1] || currentlyPressed[6] || currentlyPressed[7]) {
			button = 9;
		} else if (currentlyPressed[12] && currentlyPressed[15]) {
			button = 4;
		} else if (currentlyPressed[13] && currentlyPressed[15]) {
			button = 5;
		} else if (currentlyPressed[13] && currentlyPressed[14]) {
			button = 6;
		} else if (currentlyPressed[12] && currentlyPressed[14]) {
			button = 7;
		} else if (currentlyPressed[12]) {
			button = 0;
		} else if (currentlyPressed[13]) {
			button = 1;
		} else if (currentlyPressed[14]) {
			button = 2;
		} else if (currentlyPressed[15]) {
			button = 3;
		} 
		
		return button;
	}
	
	// Function we continuously loop through to check for buttons being pressed and released
    function reportOnGamepad() {
        var DS4 = navigator.getGamepads()[0];
        var html = "<br>";
        
		timeCounter++;
		if (timeCounter % 20 == 0) {
			console.log("TimeCounter: " + timeCounter);
			currentPosition = 0;
			buttonLog = "";
		}
		
        for (var i = 0; i < DS4.buttons.length; i++) {
            html += buttons[i] + ": ";
            if (DS4.buttons[i].pressed) {
			     html+= " pressed";
				 currentlyPressed[i] = true;
				 
			} else {
				currentlyPressed[i] = false;
			}
			
            html += "<br/>";
        }

		html += "<br>" 		
		html += "<br> Current Position in Array : " + currentPosition + "<br>";		
		html += "Currently Pressing: ";
        for (var i = 0; i < DS4.buttons.length; i++) {
            
            if (DS4.buttons[i].pressed) {
			    html += buttons[i] + " ";
				 				 
				// A new button has been pressed,move DFA position
				if (previouslyPressed[i] === false) { 
				    determinePosition(false);
				//	buttonLog += buttons[i] + " ";					
				}
				
			} else {
				// A button has been released, only move DFA position if diagonals
				if (previouslyPressed[i] === true) { 
				    determinePosition(true);				
				}		
			}         
        }
				
		for (var i = 0; i < 18; i++) previouslyPressed[i] = currentlyPressed[i];
				
		html += "<br>Button Log: " + buttonLog + "<br/>";				
		html += "<br/><br/>Joysticks<br/>";
		for(var i = 0;i < DS4.axes.length; i += 2) {
            html += "Stick " + (Math.ceil(i/2) + 1 ) + ": " + DS4.axes[i] + "," + DS4.axes[i + 1] + "<br/>";
        }
 		
        $("#display").html(html);
    }
 
    $(document).ready(function() {
 		
        if ("getGamepads" in navigator) {
  
            $("#connectionInfo").text("Connect PS4 controller and press a button");
 
            $(window).on("connectionInfo", function() {
                hasDS4 = true;
                $("#connectionInfo").html("Controller is currently connected");                
                reportDS4 = window.setInterval(reportOnGamepad,50);
            });
 
            $(window).on("gamepaddisconnected", function() {                
                $("#connectionInfo").text("Connect PS4 controller and press a button");
                window.clearInterval(reportDS4);
            });
             
            var checkGP = window.setInterval(function() {                
                if (navigator.getGamepads()[0]) {
                    if (!hasDS4) $(window).trigger("connectionInfo");
                    window.clearInterval(checkGP);
                }
            }, 500);
        }
 
    });
    </script>
	
	<body> 
		<h1>Controller Demo</h1>
		<div id="connectionInfo"></div>
		<div id="display"></div>
		<br/>		
		<div id="move" style="font-size:300%"></div>	
	</body>    
</html>