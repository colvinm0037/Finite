<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <script type="text/javascript" src="jquery-2.2.1.min.js"></script> 
    </head>
    
	<script>		
	var buttons = ["X", "Circle", "Square", "Triangle", "L1", "R1", "L2", "R2", "Share", "Options", "L3", "R3", "Up", "Down", "Left", "Right", "Home", "Touchpad"];
    var previouslyPressed = [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false];
	var currentlyPressed = [false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false, false];
	var hasDS4 = false;
	var lastPress = "";
    var reportDS4;
	var buttonLog = "";

	// Note: DFA charts use simplified mapping. Controller has 18 buttons, but we only care about 8 directions and punch + kick
	var revisedMappings = ["Up", "Down", "Left", "Right", "Up-Right", "Down-Right", "Down-Left", "Up-Left", "Punch", "Kick"];
	
	// Fighter Variables
	var selectedPlayer = 0;
	var RYU = 0;
	var BLANKA = 1;
	var fighters = ["Ryu", "Blanka"];	
	
	var specialMoveStates = [
							 [4, 7, 11, 17, 21], 
							 [4, 5, 9, 11, 15]
							];
	var specialMoveNames = [
							["HURRICANE KICK", "HADOKEN", "SHINKU HADOKEN", "SHAKUNETSU HADOKEN", "SHORYUKEN"], // RYU's Moves
							["TIGER SHOT", "GROUND TIGER SHOT", "TIGER GENOCIDE", "TIGER KNEE CRUSH", "TIGER UPPERCUT"] // SAGAT's Moves
						   ];
	
  	var mappings = [
					[ 
					 // Ryu's Moves
					 [0, 1, 12, 18, 0, 0, 0, 0, 0, 0],  // state 0
					 [0, 1, 12, 18, 0, 5, 2, 0, 0, 0],  // state 1
					 [0, 1, 3, 18, 0, 0, 0, 0, 0, 0],   // state 2
					 [0, 1, 12, 18, 0, 0, 13, 0, 0, 4], // state 3
					 [0, 1, 12, 18, 0, 0, 0, 0, 0, 0],  // state 4
					 [0, 1, 12, 6, 0, 0, 0, 0, 0, 0],   // state 5
					 [0, 8, 12, 18, 0, 0, 0, 0, 7, 0],  // state 6
					 [0, 1, 12, 18, 0, 0, 0, 0, 0, 0],  // state 7
					 [0, 1, 12, 18, 0, 9, 2, 0, 0, 0],  // state 8
					 [0, 1, 12, 10, 0, 0, 0, 0, 21, 0], // state 9
					 [0, 8, 12, 18, 0, 0, 0, 0, 11, 0], // state 10
					 [0, 1, 12, 18, 0, 0, 0, 0, 0, 0],  // state 11
					 [0, 1, 12, 18, 0, 0, 13, 0, 0, 0], // state 12
					 [0, 14, 12, 18, 0, 0, 2, 0, 0, 0], // state 13
					 [0, 1, 12, 18, 0, 15, 0, 0, 0, 0], // state 14
					 [0, 1, 12, 16, 0, 0, 0, 0, 0, 0],  // state 15
					 [0, 8, 12, 18, 0, 0, 0, 0, 17, 0], // state 16
					 [0, 1, 12, 18, 0, 0, 0, 0, 0, 0],  // state 17
					 [0, 19, 12, 18, 0, 0, 0, 0, 0, 0], // state 18
					 [0, 1, 12, 18, 0, 20, 2, 0, 0, 0], // state 19
					 [0, 1, 12, 18, 0, 6, 0, 0, 21, 0], // state 20
					 [0, 1, 12, 18, 0, 0, 0, 0, 0, 0],  // state 21
					],
					 // Sagat's moves
					[ 
					 [0, 1, 0, 12, 0, 0, 0, 0, 0, 0],  // state 0
					 [0, 1, 0, 12, 0, 2, 0, 0, 0, 0],  // state 1
					 [0, 1, 0, 3, 0, 0, 0, 0, 0, 0],  // state 2
					 [0, 6, 0, 12, 10, 0, 0, 0, 4, 5], // state 3
					 [0, 1, 0, 12, 0, 0, 0, 0, 0, 0],  // state 4
					 [0, 1, 0, 12, 0, 0, 0, 0, 0, 0], // state 5
					 [0, 1, 0, 12, 0, 7, 0, 0, 0, 0], // state 6
					 [0, 1, 0, 8, 0, 0, 0, 0, 15, 0], // state 7
					 [0, 6, 0, 12, 10, 0, 0, 0, 9, 5], // state 8
					 [0, 1, 0, 12, 0, 0, 0, 0, 0, 0], // state 9
					 [0, 1, 0, 12, 0, 0, 0, 0, 0, 11], // state 10
					 [0, 1, 0, 12, 0, 0, 0, 0, 0, 0], // state 11
					 [0, 13, 0, 12, 0, 0, 0, 0, 0, 0], // state 12
					 [0, 1, 0, 12, 0, 14, 0, 0, 0, 0], // state 13
					 [0, 1, 0, 3, 0, 0, 0, 0, 15, 0], // state 14
					 [0, 1, 0, 12, 0, 0, 0, 0, 0, 0], // state 15
					]
				   ];
	
    var currentPosition = 0;
	var timeCounter = 0;
	
	function determinePosition(diagonals) {
	
		var button = 0;		
		
		// Process the controller input
		if (diagonals === true) {
			button = diagonalMapping();
		}
		else {
			button = regularMapping();
		}
		
		if (button === -1) {
			return; // Not an accepted controller input
		}
		
		// We have accepted the controller input. Reset time reset counter, display button press, and move to next DFA position.
		timeCounter = 0;
		buttonLog += revisedMappings[button] + " ";		
		currentPosition = mappings[selectedPlayer][currentPosition][button];
		
		// Determine if we are now in a special move state
		var move = "None";	

		// Are we in a special move state for the selected player?
		var specialMoveLocation = $.inArray(currentPosition, specialMoveStates[selectedPlayer]);
		
		if (specialMoveLocation != -1) {
			move = specialMoveNames[selectedPlayer][specialMoveLocation];
		}
		
		// Display the move 
		$("#move").html("Special Move: " + move);
	}
	
	// Simplified Mappings only for diagonals
	function diagonalMapping() {
	
		var button = -1;

		if (currentlyPressed[12]) {
			button = 0;
		} else if (currentlyPressed[13]) {
			button = 1;
		} else if (currentlyPressed[14]) {
			button = 2;
		} else if (currentlyPressed[15]) {
			button = 3;
		} 

		return button;
	}

	// Simplified mappings for all actions we care about
	function regularMapping() {
		
		var button= -1;
		
		if (currentlyPressed[2] || currentlyPressed[3] || currentlyPressed[4] || currentlyPressed[5]) {
			button = 8;
		} else if (currentlyPressed[0] || currentlyPressed[1] || currentlyPressed[6] || currentlyPressed[7]) {
			button = 9;
		} else if (currentlyPressed[12] && currentlyPressed[15]) {
			button = 4;
		} else if (currentlyPressed[13] && currentlyPressed[15]) {
			button = 5;
		} else if (currentlyPressed[13] && currentlyPressed[14]) {
			button = 6;
		} else if (currentlyPressed[12] && currentlyPressed[14]) {
			button = 7;
		} else if (currentlyPressed[12]) {
			button = 0;
		} else if (currentlyPressed[13]) {
			button = 1;
		} else if (currentlyPressed[14]) {
			button = 2;
		} else if (currentlyPressed[15]) {
			button = 3;
		} 
		
		return button;
	}
	
	function updatePlayer() {
		var p = document.getElementById("playerSelect").value;
		if (p === "ryu") {
			selectedPlayer = 0;			
		} else if (p === "sagat") {
			selectedPlayer = 1;			
		}
	}
	
	// Function we continuously loop through to check for buttons being pressed and released
    function reportOnGamepad() {
        var DS4 = navigator.getGamepads()[0];
        var html = "<br>";
        
		timeCounter++;
		if (timeCounter % 20 == 0) {			
			currentPosition = 0;
			buttonLog = "";
		}
		
        for (var i = 0; i < DS4.buttons.length; i++) {
            html += buttons[i] + ": ";
            if (DS4.buttons[i].pressed) {
			     html+= " pressed";
				 currentlyPressed[i] = true;				 
			} else {
				currentlyPressed[i] = false;
			}
			
            html += "<br/>";
        }

		html += "<br>" 		
		html += "<br> Current Position in Array : " + currentPosition + "<br>";		
		html += "Currently Pressing: ";
        for (var i = 0; i < DS4.buttons.length; i++) {
            
            if (DS4.buttons[i].pressed) {
			    html += buttons[i] + " ";
				 				 
				// A new button has been pressed,move DFA position
				if (previouslyPressed[i] === false) { 
				    determinePosition(false);				
				}
				
			} else {
				// A button has been released, only move DFA position if diagonals
				if (previouslyPressed[i] === true) { 
				    determinePosition(true);				
				}		
			}         
        }
				
		for (var i = 0; i < 18; i++) previouslyPressed[i] = currentlyPressed[i];
		
		html += "<br/><br/>Joysticks<br/>";
		for(var i = 0;i < DS4.axes.length; i += 2) {
            html += "Stick " + (Math.ceil(i/2) + 1 ) + ": " + DS4.axes[i] + "," + DS4.axes[i + 1] + "<br/>";
        }
 		
        $("#controllerInfo").html(html);
		$("#buttonDisplay").html("Buttons: " + buttonLog);
    }
 
    $(document).ready(function() {
 		
        if ("getGamepads" in navigator) {
  
            $("#connectionInfo").text("Connect PS4 controller and press a button");
 
            $(window).on("connectionInfo", function() {
                hasDS4 = true;
                $("#connectionInfo").html("Controller is currently connected");                
                reportDS4 = window.setInterval(reportOnGamepad,50);
				$("#main").show();
            });
 
            $(window).on("gamepaddisconnected", function() {                
                $("#connectionInfo").text("Connect PS4 controller and press a button");
                window.clearInterval(reportDS4);
				$("#main").hide();
            });
             
            var checkGP = window.setInterval(function() {                
                if (navigator.getGamepads()[0]) {
                    if (!hasDS4) $(window).trigger("connectionInfo");
                    window.clearInterval(checkGP);
                }
            }, 500);
        }
 
    });
    </script>
	
	<body> 
		<h1>Controller Demo</h1>
		
		<div id="connectionInfo"></div>
		<br/>
		<div id="main" style="display: none;">
			
			<div id="buttons">
				<button type="button" onclick="$('#controllerInfo').toggle();">Controller Info</button>
				<button type="button" onclick="$('#programInfo').toggle();">Program Info</button>
			</div>
			
			<div id="controllerInfo" style="display: none;"></div>
			
			<div id="programInfo" style="display: none;">
			    <p>
				  Written by Micah Colvin.<br>
				  Moves taken from Street Fighter II Turbo. <br>
				  Written for Formal Languages and Finite Automata, Spring 2016. <br>				
				</p>
			</div>
			
			<br/>
			
			<select id="playerSelect" onchange="updatePlayer()">
			  <option value="ryu">Ryu</option>
			  <option value="sagat">Sagat</option>
			</select>		
			
			<br/><br/>
			
			<div id="buttonDisplay" style="font-size:200%"></div>	
			<div id="move" style="font-size:300%">Special Move:</div>	
		</div>
	</body>    
</html>